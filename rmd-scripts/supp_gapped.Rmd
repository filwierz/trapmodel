---
title: "supp_gapped"
author: "Filip Wierzbicki"
date: "7/19/2022"
output: html_document
---

  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This scripts includes also the less well assembled gapped clusters for additional analysis of TE abundance.


```{bash gapped counts, eval=FALSE}
cd /Users/filipwierzbicki/Desktop/trap_model/analysis/abu/cusco_tas/gapped_combined-distinct

for i in *_cluster.bed;do n=${i%_cluster.bed};mkdir ${n};python /Users/filipwierzbicki/Desktop/trap_model/github/trapmodel/helper-scripts/assembly_TE-abundance_3types.py --clu $i --ref ../ref_recover/ref_bed/${n}_ref.bed --rm /Users/filipwierzbicki/Desktop/trap_model/analysis/abu/whole-genome/repeatmasker/${n}.fasta.out --output ${n}/ --sample ${n} --approach gapped_cusco_tas --minlen 100 --maxdiv 10.0 ;done

```

```{bash protrac gapped clusters,eval=FALSE}
cd /Users/filipwierzbicki/Desktop/trap_model/analysis/abu/protrac/protrac_gapped_cluster_bed
for i in *_p0.05_cluster.bed;do n=${i%_p0.05_cluster.bed};mkdir ${n};python /Users/filipwierzbicki/Desktop/trap_model/github/trapmodel/helper-scripts/assembly_TE-abundance_3types.py --clu $i --rm /Users/filipwierzbicki/Desktop/trap_model/analysis/abu/whole-genome/repeatmasker/${n}.fasta.out --output ${n}/ --sample ${n}_p0.05 --approach gapped_protrac --minlen 100 --maxdiv 10.0 ;done

```

```{R,eval=TRUE}

library(dplyr)
library(ggplot2)
library(ggpubr)

#######
###For population frequency Info based on Kofler et al. 2015 PLOS Genetics
info1<-read.table("/Users/filipwierzbicki/Desktop/evolution_cluster/temp/TEfamInfo_correct")
names(info1)<-c("name","TE","order","AF","popins")
###exclude somatically regulated TEs based on Malone et al. 2009 Cell
info1<-subset(info1,name!="gypsy10"&name!="gypsy"&name!="ZAM"&name!="gtwin"&name!="gypsy5"&name!="Tabor")
info<-subset(info1,select=c("TE","AF"))
info$AF<-round(info$AF,digits = 1)


t1<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/cusco_tas/gapped_combined-distinct/Canton-S_gapped_cusco_tas_summary.forR")
t2<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/cusco_tas/gapped_combined-distinct/DGRP-732_gapped_cusco_tas_summary.forR")
t3<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/cusco_tas/gapped_combined-distinct/Iso1_gapped_cusco_tas_summary.forR")
t4<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/cusco_tas/gapped_combined-distinct/Oregon-R_gapped_cusco_tas_summary.forR")
t5<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/cusco_tas/gapped_combined-distinct/Pi2_gapped_cusco_tas_summary.forR")

tq<-rbind(t1,t2,t3,t4,t5)
names(tq)<-c("count","id","TE","region")

ht<-tq
ht$id2<-paste(ht$id,ht$TE,sep="+")

cl<-subset(ht,region=="cluster")
cl<-subset(cl,select=c("count","id2"))

rest<-subset(ht,region!="cluster")
rest<-subset(rest,select=c("count","id2"))
for (sid in unique(rest$id2)) { 
  i <- rest$id2 == sid
  a = sum(rest$count[i])
  rest$sum[i] = a
}
rest<-subset(rest,select=c("sum","id2"))
names(rest)<-c("count","id2")
rest<-unique(rest)

cr<-full_join(cl,rest,by="id2")
names(cr)<-c("cluster","id2","noncluster")

cr$id<-gsub("\\+.*","",cr$id2)
cr$TE<-gsub(".*\\+","",cr$id2)
ht<-cr
ht<-left_join(ht,info,by="TE")

#including AF threshold
ht<-subset(ht,AF!="NA")##remove missing AFs
ht<-subset(ht,AF<=0.2)

ht[is.na(ht)] <- 0

ht$id3<-paste(ht$cluster,ht$TE,sep="_")

for (sid in unique(ht$id3)) { 
  i <- ht$id3 == sid
  a = nrow(subset(ht,id3==sid))
  ht$sum[i] = a
}

ht<-subset(ht,select=c("cluster","TE","sum"))
ht<-unique(ht)
for (sid in unique(ht$cluster)) { 
  i <- ht$cluster == sid
  b = sum(ht$sum[i])
  ht$inds[i] = b
}

ht<-subset(ht,select=c("cluster","inds"))
ht<-unique(ht)

ht$indsrel<-ht$inds/sum(ht$inds)


real<-ggplot(ht, aes(x=cluster, y=indsrel)) + geom_bar(stat="identity")+ylab("frequency of individuals")+xlab("number of cluster insertions")#+ geom_vline( xintercept =alq,col="red") + geom_vline( xintercept =auq,col="red")#+xlim(-1,160)+ylim(0,0.35)


t<-tq
t$id2<-paste(t$id,t$TE,sep="+")

cl<-subset(t,region=="cluster")
cl<-subset(cl,select=c("count","id2"))

rest<-subset(t,region!="cluster")
rest<-subset(rest,select=c("count","id2"))
for (sid in unique(rest$id2)) { 
  i <- rest$id2 == sid
  a = sum(rest$count[i])
  rest$sum[i] = a
}
rest<-subset(rest,select=c("sum","id2"))
names(rest)<-c("count","id2")
rest<-unique(rest)

cr<-full_join(cl,rest,by="id2")
names(cr)<-c("cluster","id2","noncluster")

cr$id<-gsub("\\+.*","",cr$id2)
cr$TE<-gsub(".*\\+","",cr$id2)


t<-cr


t[is.na(t)] <- 0


for (sid in unique(t$TE)) { 
  i <- t$TE == sid
  a = mean(t$cluster[i])
  b = mean(t$noncluster[i])
  t$avrcl[i] = a
  t$avrrest[i] = b
}

t<-subset(t,select = c("TE","avrcl","avrrest"))
t<-unique(t)



t<-left_join(t,info,by="TE")
#including AF threshold
t<-subset(t,AF!="NA")##remove missing AFs
t<-subset(t,AF<=0.2)

cC<-t

cC$cluster<-log10(cC$avrcl+1)
cC$noncluster<-log10(cC$avrrest+1)



gC<-ggplot(cC,aes(x=noncluster,y=cluster))+geom_point()+stat_cor(method = "pearson", label.x = 0.7, label.y = 2,size=3)+ 
  geom_smooth(method='lm', formula= y~x)+xlab("non-cluster insertions")+ylab("cluster insertions")+scale_x_continuous(breaks=c(0,1,2,3),labels=c("0","9","99","999"))+scale_y_continuous(breaks=c(0,1,2,3),labels=c("0","9","99","999"))


####gapped proTRAC clusters:


t1<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/protrac/protrac_gapped_cluster_bed/Canton-S_p0.05_gapped_protrac_summary.forR")
t2<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/protrac/protrac_gapped_cluster_bed/DGRP-732_p0.05_gapped_protrac_summary.forR")
t3<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/protrac/protrac_gapped_cluster_bed/Iso1_p0.05_gapped_protrac_summary.forR")
t4<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/protrac/protrac_gapped_cluster_bed/Oregon-R_p0.05_gapped_protrac_summary.forR")
t5<-read.table("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/protrac/protrac_gapped_cluster_bed/Pi2_p0.05_gapped_protrac_summary.forR")

tq<-rbind(t1,t2,t3,t4,t5)
names(tq)<-c("count","id","TE","region")

ht<-tq
ht$id2<-paste(ht$id,ht$TE,sep="+")

cl<-subset(ht,region=="cluster")
cl<-subset(cl,select=c("count","id2"))

rest<-subset(ht,region!="cluster")
rest<-subset(rest,select=c("count","id2"))
for (sid in unique(rest$id2)) { 
  i <- rest$id2 == sid
  a = sum(rest$count[i])
  rest$sum[i] = a
}
rest<-subset(rest,select=c("sum","id2"))
names(rest)<-c("count","id2")
rest<-unique(rest)

cr<-full_join(cl,rest,by="id2")
names(cr)<-c("cluster","id2","noncluster")

cr$id<-gsub("\\+.*","",cr$id2)
cr$TE<-gsub(".*\\+","",cr$id2)
ht<-cr
ht<-left_join(ht,info,by="TE")

#including AF threshold
ht<-subset(ht,AF!="NA")##remove missing AFs
ht<-subset(ht,AF<=0.2)

ht[is.na(ht)] <- 0

ht$id3<-paste(ht$cluster,ht$TE,sep="_")

for (sid in unique(ht$id3)) { 
  i <- ht$id3 == sid
  a = nrow(subset(ht,id3==sid))
  ht$sum[i] = a
}

ht<-subset(ht,select=c("cluster","TE","sum"))
ht<-unique(ht)
for (sid in unique(ht$cluster)) { 
  i <- ht$cluster == sid
  b = sum(ht$sum[i])
  ht$inds[i] = b
}

ht<-subset(ht,select=c("cluster","inds"))
ht<-unique(ht)

ht$indsrel<-ht$inds/sum(ht$inds)


realpro<-ggplot(ht, aes(x=cluster, y=indsrel)) + geom_bar(stat="identity")+ylab("frequency of individuals")+xlab("number of cluster insertions")#+ geom_vline( xintercept =alq,col="red") + geom_vline( xintercept =auq,col="red")#+xlim(-1,160)+ylim(0,0.35)


t<-tq
t$id2<-paste(t$id,t$TE,sep="+")

cl<-subset(t,region=="cluster")
cl<-subset(cl,select=c("count","id2"))

rest<-subset(t,region!="cluster")
rest<-subset(rest,select=c("count","id2"))
for (sid in unique(rest$id2)) { 
  i <- rest$id2 == sid
  a = sum(rest$count[i])
  rest$sum[i] = a
}
rest<-subset(rest,select=c("sum","id2"))
names(rest)<-c("count","id2")
rest<-unique(rest)

cr<-full_join(cl,rest,by="id2")
names(cr)<-c("cluster","id2","noncluster")

cr$id<-gsub("\\+.*","",cr$id2)
cr$TE<-gsub(".*\\+","",cr$id2)


t<-cr


t[is.na(t)] <- 0


for (sid in unique(t$TE)) { 
  i <- t$TE == sid
  a = mean(t$cluster[i])
  b = mean(t$noncluster[i])
  t$avrcl[i] = a
  t$avrrest[i] = b
}

t<-subset(t,select = c("TE","avrcl","avrrest"))
t<-unique(t)



t<-left_join(t,info,by="TE")
#including AF threshold
t<-subset(t,AF!="NA")##remove missing AFs
t<-subset(t,AF<=0.2)

cC<-t

cC$cluster<-log10(cC$avrcl+1)
cC$noncluster<-log10(cC$avrrest+1)



gCpro<-ggplot(cC,aes(x=noncluster,y=cluster))+geom_point()+stat_cor(method = "pearson", label.x = 1, label.y = 2,size=3)+ 
  geom_smooth(method='lm', formula= y~x)+xlab("non-cluster insertions")+ylab("cluster insertions")+scale_x_continuous(breaks=c(0,1,2,3),labels=c("0","9","99","999"))+scale_y_continuous(breaks=c(0,1,2,3),labels=c("0","9","99","999"))






####combine:

gGAP<-ggarrange(gC,real,gCpro,realpro,
                labels = c("A","B","C","D"),
                ncol = 2, nrow = 2)
plot(gGAP)

ggsave("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/figures/supp_Gapped.png",width=8,height=6)
ggsave("/Users/filipwierzbicki/Desktop/trap_model/analysis/abu/figures/supp_Gapped.pdf",width=8,height=6)
```
